---
title: "Phase 1: Data Wrangling"
title-block-banner: true
toc: true
editor: visual
execute: 
  freeze: true
  warning: false
  #echo: false
  #message: false
  html:
    code-fold: True
    code-overflow: scroll
    code-summary: "Show the code"
    code-line-numbers: true
---

# 1 PISA Data

The PISA Data from 2000 to 2022 are available on the [OECD website](https://www.oecd.org/pisa/data/).

# 2 Getting Started

| **Library**                                 | **Description**                                                                                               |
|------------------------|-----------------------------------------------|
| [**tidyverse**](https://www.tidyverse.org/) | A collection of core packages designed for data science, used extensively for data preparation and wrangling. |
| [**haven**](https://haven.tidyverse.org/)   | To enable R to read and write various data formats such as SAS and SPSS.                                      |
| [**knitr**](https://yihui.org/knitr/)       | For dynamic report generation.                                                                                |

: {tbl-colwidths="\[20,80\]"}

The following code chunk uses `p_load()` of [**pacman**](https://rpubs.com/akshaypatankar/594834) package to check if tidyverse packages are installed in the computer. If they are, the libraries will be called into R.

```{r}
pacman::p_load(tidyverse, haven, knitr, 
               sjlabelled,
               gt)
```

# 3 Reading Data into R

The next two sections cover the steps taken to read in the raw data.

## 3.1 Importing sas file

From PISA 2015 and its later cycles, SAS data sets (`.sas`) are available with all countries in the file for each respondent type.

The code chunk below imports the *2015, 2018, 2022 Student Questionnaire* dataset downloaded from OECD's PISA Database using the following functions:

-   `list.files()` to identify all SAS files in the data directory and stores their paths in *filename* variable

-   `for (i in 1:length(filenames))` iterates over each file identified, and:

    -   `read_sas()` function of the [**haven**](https://haven.tidyverse.org/) package to import each file into the R environment,

    -   `sub()` to extract parts of the file name without extension and parent directory path,

    -   `assign()` assigns extracted partial file name to the data that was read,

```{r}
#| eval: false

# List of all SAS files in directory
filenames <- list.files(path = "data/",
                        pattern = "*.sas7bdat",
                        full.names = T)

for (i in 1:length(filenames))
{
  name <- sub("^.*?/(.*?)(\\.sas7bdat)$", "\\1", filenames[i])
  data <- read_sas(filenames[i])
  assign (name, data)
}
```

## 3.2 Importing txt file with dictionary

PISA 2012 and its earlier cycles' data are provided in 2 forms -- a fixed width (or ASCII) text format (`.txt`), and the corresponding SAS import control syntax file (`.sas`) for reading the data.

```{r}
#| eval: false

# Loading the dictionary
dict_student_2012 = SAScii::parse.SAScii(sas_ri = 'data/PISA2012_SAS_student.sas')

# Creating the positions to read_fwf
stu_qqq_2012 <- read_fwf(file = 'data/stu_qqq_2012.txt', col_positions = fwf_widths(dict_student_2012$width), progress = T)

# Assigns column headers using dictionary
colnames(stu_qqq_2012) <- dict_student_2012$varname
```

Each dataset is a tibble dataframe, containing observations (rows) across variables (columns). Each observation corresponds to an entry from a student who participated in the PISA survey for students in the respective years, and the variables correspond to information from students on various aspects of their home, family, and school background.

# 4 Data Wrangling

```{mermaid}
%%| fig-width: 8
%%| echo: false

flowchart TD

    A[PISA Survey] --> A1[2022 Data Student Questionnaire] 


    A1 -.-> A11(Gender)
    A1 -.-> A12(Socio-economic)
    A1 -.-> A13(Psychological Wellbeing)
    A1 -.-> A14(Schools)  

    A1 -.-> A2   
    A2[Combine 2012-2018]-.->A3(Longitudinal)

    



```

The data manipulation is performed in 2 parts:

-   *Longitudinal data:* To conduct longitudinal comparisons of PISA scores of Singapore students across different years.
-   *Detailed 2022 Student's Questionnaire data:* To compare the PISA scores between different groups of students based on factors such as gender, socioeconomic status (e.g., employment status of parents, immigrant status), and psychological well-being (e.g., feeling of loneliness, resilience when faced with challenges). On top of that, we aim to gain an understanding of the varying levels of importance and statistical significance of the various influences on PISA scores for different clusters of students.

## 4.1 Filtering for required dataset

### 4.1.1 The Longitudinal Data

The helper function below is designed to extract and process data for longitudinal analysis of student scores in Math, Science and Reading. Let's break down the function:

1.  *Object*: The expected argument *object* retrieves the name of object which the survey is stored in.
2.  `deparse(substitute(object))`: Returns the name of the object as a character string and stores this as a variable *filename*.
3.  `filter()`: Filters the dataset to only include responses from Singapore students.
4.  `select()`: Retains columns that starts with "PV" and contains either "MATH", "SCIE", or "READ" to extract the plausible values of scores related to the subjects of Mathematics, Science, and Reading.
    1.  `starts_with()`: Matches the beginning of the column name with "PV", and
    2.  `contains()`: Searches for columns containing three alternative subjects to be matched.
5.  `mutate()`: Creates new columns to contain newly derived variables.
    -   *year*: Represent the responses it pertains to, extracted from the file name using `substr()`.
    -   *math*, *reading*, *science*: Calculates the mean plausible value for math, reading, and science scores for each student using `rowMeans()` applied across selected columns identified by \`select()\`\`

```{r}
#| eval: false

long <- function(object) {
  
  filename <- deparse(substitute(object))
  
  result <- object %>% 
    filter(CNT == "SGP") %>% 
    select(starts_with("PV") & contains(c("MATH", "READ", "SCIE"))) %>% 
    mutate(year = substr(filename, 9, 12),
           math = rowMeans(across(starts_with("PV") & contains("MATH")), na.rm = TRUE),
           reading = rowMeans(across(starts_with("PV") & contains("READ")), na.rm = TRUE),
           science = rowMeans(across(starts_with("PV") & contains("SCIE")), na.rm = TRUE),
           ) %>% 
    select(year, math, reading, science)
  
  return(result)
}

```

Let's get the required data using the `long` function defined and combine all the results from various years together in 1 dataset named *stu_longitudinal* using `bind_rows()`.

```{r}
#| eval: false
long_2012_SG <- long(stu_qqq_2012)
long_2015_SG <- long(stu_qqq_2015)
long_2018_SG <- long(stu_qqq_2018)
long_2022_SG <- long(stu_qqq_2022)

stu_longtitudinal <-
  bind_rows(list(long_2012_SG,
                long_2015_SG,
                long_2018_SG,
                long_2022_SG))
```

The *.rds* file format is usually smaller than its SAS file counterpart and will therefore take up less storage space. The *.rds* file will also preserve data types and classes such as factors and dates eliminating the need to redefine data types after loading the file. For fast and space efficient data storage, files can be exported as RDS and re-imported into R using [`write_rds()`](https://readr.tidyverse.org/reference/read_rds.html) and [`read_rds()`](https://readr.tidyverse.org/reference/read_rds.html) respectively.

```{r}
#| eval: false
write_rds(stu_longtitudinal, "data/stu_longtitudinal.rds")
```

```{r}
stu_longtitudinal <- read_rds("data/stu_longtitudinal.rds")
```

Let's take a look at the first 10 rows of our longitudinal dataset.

```{r}
#| echo: false

DT::datatable(head(stu_longtitudinal, 10),
              filter = 'top',
              class = "compact",
              options = list(pageLength = 5, dom = 'tip'))
```

### 4.1.2 The 2022 Student's Questionnaire data

After perusing through the [Codebook](https://webfs.oecd.org/pisa2022/CY08MSP_CODEBOOK_5thDecember23.xlsx) and [Technical Report](https://www.oecd.org/pisa/data/pisa2022technicalreport/), the team narrowed down the questions from the survey that would yield insightful results. The names of the columns are stored in a *.csv* file named *colname*.

To filter the raw dataset with the columns, we first import *colname* into R environment using [`read_csv()`](https://readr.tidyverse.org/reference/read_delim.html) function of [**readr**](https://readr.tidyverse.org/) package.

```{r}
#| eval: false
colname <- read_csv("data/colname.csv")
```

The following code chunk serves the following purpose:

-   `filter()` of the [**dplyr**](https://dplyr.tidyverse.org/) package to extract Singapore responses, where *CNT = SGP*, for a more focused analysis,

-   `select()` function:

    -   To keep columns identified in *colname*
    -   Retain only variables with \<20% missing values

-   `mutate()`Â to create 3 new variables to store the mean plausible values for each subject for each row using `rowMeans()` and `across()`.

-   `starts_with()` and `contains()` helps identify the columns relating to the subject.

```{r}
#| eval: false

stu_qqq_2022_SG <- stu_qqq_2022 %>% 
  
  # Filter each dataset for CNT = "SGP"
  filter(CNT == "SGP") %>% 

  # Retains desired variables
  select(colname$colname) %>% 

  # Retains variables with <20% missing values
  select(which(colSums(is.na(.))/nrow(.) < 0.2)) %>% 

  # Calculates the mean of plausible values for each subject per student
  mutate(math = rowMeans(across(starts_with("PV") & contains("MATH")), na.rm = TRUE),
         reading = rowMeans(across(starts_with("PV") & contains("READ")), na.rm = TRUE),
         science = rowMeans(across(starts_with("PV") & contains("SCIE")), na.rm = TRUE),
         ) %>% 
  
  # Drops Plausible Values columns
  select(-starts_with("PV"))


```

`stu_qqq_2022_SG` contains 6606 observations across 266 variables.

```{r}
#| eval: false
write_rds(stu_qqq_2022_SG, "data/stu_qqq_2022_SG.rds")
```

```{r}
stu_qqq_2022_SG <- read_rds("data/stu_qqq_2022_SG.rds")

```

## 4.2 Recoding Questionnaire Responses

There are several types of responses for the Student's Questionnaire. For a start, I will store the levels and their numerical for the Yes/No questions in a vector to be applied to all the questions using a similar scale.

```{r}
#| eval: false
yesno <- c('1' = "Yes", 
            '2' = "No")

yesno_col <- starts_with("ST250Q",)

count <- c('1' = "0", 
           '2' = "1",
           '3' = "2",
           '4' = ">2")

count_col <- starts_with("ST251Q")

digicount <- c('1' = "0",
                  '2' = "1 or 2",
                  '3' = "3-5",
                  '4' = ">5",
                  '5' = "I don't know")

digicount_col <- starts_with("ST254Q")

bookcount <- c('1' = "0",
               '2' = "1-5",
               '3' = "6-10",
               '4' = ">10",
               '5' = "I don't know")
  
  
bookcount_col <- starts_with("ST256Q")

country <- c('1' = "Singapore",
             '2' = "Other Country")

country_col <- starts_with("ST019")


agreedisagree <- c('1' = "Strongly Disagree",
                   '2' = "Disagree",
                   '3' = "Agree",
                   '4' = "Strongly Agree")

agreedisagree_col <- starts_with("ST267Q")

```

# Data Health

## Duplicates Check
